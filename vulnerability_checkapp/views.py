from django.shortcuts import render
from .models import *
from django.http import HttpResponse,JsonResponse
import requests
from bs4 import BeautifulSoup
from readwebpage import *
# Create your views here.
#-----------------------------------------------------------loading index page 
def index(request):
    print ("index")
    return render(request,"index.html",{})
def index_pg(request):
    print ("index")
    return render(request,"index.html",{})
#-----------------------------------------------------------loading login page 
def login_pg(request):
    print ("login_pg")
    return render(request,"login.html",{})
#-----------------------------------------------------------loading registration page 
def register_pg(request):
    print ("register_pg")
    return render(request,"index.html",{})
#-----------------------------------------------------------loading userhome page 
def uhome(request):
    print ("uhome")
    return render(request,"about.html",{})
#-----------------------------------------------------------loading back page 
def back(request):
    print ("back")
    return render(request,"home.html",{})
#-----------------------------------------------------------loading userhome page 
def res(request):
    print ("res")
    return render(request,"result.html",{})
def res1(request):
    print ("res1")
    return render(request,"result1.html",{})

##-------------------registration------------------------
#-----------------------------------------------------------registration function
def register(request):
    print ("in regiseter")
    if request.method=="POST":
        name=request.POST.get("name")
        email=request.POST.get("email")
        uname=request.POST.get("username")
        paswd=request.POST.get("Password")
        print ("name,email,uname,paswd",name,email,uname,paswd)
        user_data=register_tb.objects.filter(username=uname)
        count=user_data.count()
        if count==0:
            obj=register_tb(
                name=name,email=email,username=uname,password=paswd,role="user"
                )
            obj.save()
            print("registerd")
            return HttpResponse("<script>alert('Registration successful');window.location.href=/login_pg/;</script>")
        else:
            print("already exist")
            return HttpResponse("<script>alert('Registration unsuccessful, please register with another username');window.location.href=/register_pg/;</script>")
##-------------------registration------------------------
#-------------------------------------------------------login check function----------------------------------
def login_check(request):
    print ("login_check(request):")
    if request.method=="POST":
        u=request.POST.get("username")
        p=request.POST.get("password")
        print ("in login page:",u,"::::",p)
        user_data=register_tb.objects.filter(username=u,password=p)
        count=user_data.count()
        for i in user_data:
            usertype=i.role
            userid=i.id
            print("user.....",i.username,"role........",usertype)
        if count==1 and usertype=='user':
            request.session['us_name']=userid
            print ("in if request.session::::::::::::",userid)
            user_id=register_tb.objects.get(id=request.session['us_name'])
            print ("user id:::::::::::::::::::::::::::_____________________",user_id.id)
            return HttpResponse("<script>alert('WELCOME');window.location.href=/uhome/;</script>")
        if count==0:
            usernm="user not exist"
            return HttpResponse("<script>alert('user not exist');window.location.href=/login_pg/;</script>")
        if count>1:
            return HttpResponse("<script>alert('invalid user data, please check database');window.location.href=/register_pg/;</script>")
        print("............................................................................................................................................................")
        return HttpResponse("<script>window.location.href=/adminhome/;</script>")
    return HttpResponse("<script>window.location.href=/login_pg/;</script>") 

def check_url(request):
    if request.method=="POST":
        u=request.POST.get("urldata")
        print(u)
        if 'http://' not in str(u):
            u='http://'+u
            print(u)
        r=url_check(u)
        print (r)
        if r=='not':
            return HttpResponse("<script>window.location.href=/res/;</script>")
        else:
            return HttpResponse("<script>window.location.href=/res1/;</script>")
        
def logout_fn(request):
    try:
        print ("logout_fn")
        if request.session.has_key('us_name'):
            print ("session=: deleting ",request.session['us_name'])
            del request.session['us_name']
            print ("session deleted")
        else:
##            return HttpResponse("plz login")
            return render(request,"login.html",{})
    except Exception as e:
        print ("logout error")
    return render(request,"login.html",{})
